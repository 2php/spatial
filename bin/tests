#!/bin/bash

# Set data environment variable for running this test
# export TEST_DATA_HOME="$PWD/../data/"

type=$1
file_or_tests=$2

if [ -f $file_or_tests ]; then
   tests=""
   while read LINE 
   do  
      if [[ $LINE == spatial.tests.* ]]; then 
         tests="$tests $LINE"
        echo "$LINE"
      else 
        tests="$tests spatial.tests.$LINE"
        echo "spatial.tests.$LINE"
      fi
   done <  $file_or_tests
else
   if [[ $file_or_tests == "" ]]; then
      tests="spatial.tests.*" 
   elif [[ $file_or_tests == spatial.tests.* ]]; then
      tests="$file_or_tests"
   else 
      tests="spatial.tests.$file_or_tests"
   fi
fi

fileout="test_$(date +'%m_%d_%y_%H_%M_%S').log"
echo "Running tests $tests"
echo "Logging tests to $fileout"

if [[ $type == "sim" ]]; then
  sbt -Dtest.Scala=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "vcs" ]]; then
  sbt -Dtest.VCS=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "zynq" ]]; then
  sbt -Dtest.Zynq=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "mini" ]]; then
  sbt -Dtest.Scala=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "weekly" ]]; then
  sbt -Dtest.Scala=true -Dtest.VCS=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "nightly" ]]; then
  sbt -Dtest.Scala=true -Dtest.VCS=true -Dtest.Zynq=true "testOnly $tests" 2>&1 | tee $fileout
else
  echo "Test type '$type' not recognized" 
  echo "Supported types: [sim | vcs | zynq | mini | weekly | nightly]"
  exit 1
fi

sbtExitCode=${PIPESTATUS[0]}
exit $sbtExitCode
