#!/bin/bash

# Set data environment variable for running this test
# export TEST_DATA_HOME="$PWD/../data/"

type=$1
numthreads=$2
file_or_tests=$3

if [[ $file_or_tests == "" ]]; then
   tests="spatial.tests.*" 
elif [ -f $file_or_tests ]; then
   tests=""
   while read LINE 
   do  
      if [[ $LINE == spatial.tests.* ]]; then 
         tests="$tests $LINE"
        echo "$LINE"
      else 
        tests="$tests spatial.tests.$LINE"
        echo "spatial.tests.$LINE"
      fi
   done <  $file_or_tests
elif [[ $file_or_tests == spatial.tests.* ]]; then
   tests="$file_or_tests"
else 
   tests="spatial.tests.$file_or_tests"
fi

if [[ $numthreads == "" ]]; then
  threads=1
else
  threads=$numthreads
fi

fileout="test_$(date +'%m_%d_%y_%H_%M_%S').log"
echo "Running tests $tests"
echo "Logging tests to $fileout"

if [[ $type == "sim" ]]; then
  sbt -Dmaxthreads=$threads -Dtest.Scala=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "vcs" ]]; then
  sbt -Dmaxthreads=$threads -Dtest.VCS=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "vcs-noretime" ]]; then
  sbt -Dmaxthreads=$threads -Dtest.VCS_noretime=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "vcs-gdocs" ]]; then
  export GDOCS=1
  sbt -Dmaxthreads=$threads -Dtest.VCS=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "vcs-noretime-gdocs" ]]; then
  export GDOCS=1
  sbt -Dmaxthreads=$threads -Dtest.VCS_noretime=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "zynq" ]]; then
  sbt -Dmaxthreads=$threads -Dtest.Zynq=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "aws" ]]; then
  sbt -Dmaxthreads=$threads -Dtest.AWS=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "zcu" ]]; then
  sbt -Dmaxthreads=$threads -Dtest.ZCU=true "testOnly $tests" 2>&1 | tee $fileout
elif [[ $type == "arria10" ]]; then
  sbt -Dmaxthreads=$threads -Dtest.Arria10=true "testOnly $tests" 2>&1 | tee $fileout
else
  echo "Test type '$type' not recognized" 
  echo "Supported types: [sim | vcs(-gdocs) | vcs-noretime(-gdocs) | zynq | aws | zcu | arria10]"
  exit 1
fi

sbtExitCode=${PIPESTATUS[0]}
exit $sbtExitCode
